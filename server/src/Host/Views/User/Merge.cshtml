@model UserMergeModel

@{
    ViewData["Title"] = "Объединение учетных записей " + string.Join(", ", Model.EmailSelect);
}

<h3 class="page-header">
    @ViewData["Title"]
</h3>

<form asp-controller="User" asp-action="Merge" method="post" id="userMergeForm">
    <div asp-validation-summary="All" class="text-danger"></div>
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">Основная информация</h3>
        </div>
        <div class="panel-body">
            <div class="form-horizontal">
                <div class="form-group">
                    <label asp-for="Email" class="col-md-2 control-label"></label>
                    <div class="col-md-4">
                        <select asp-for="Email" class="form-control">
                            <option></option>
                            @foreach (string email in Model.EmailSelect)
                            {
                                <option value="@email">@email</option>
                            }
                        </select>
                        <span asp-validation-for="Email" class="text-danger"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label asp-for="UserName" class="col-md-2 control-label"></label>
                    <div class="col-md-4">
                        <select asp-for="UserName" class="form-control">
                            <option></option>
                            @foreach (string userName in Model.UserNameSelect)
                            {
                                <option value="@userName">@userName</option>
                            }
                        </select>
                        <span asp-validation-for="UserName" class="text-danger"></span>
                    </div>
                </div>
                @for (int i = 0; i < Model.EmailSelect.Count; i++)
                {
                    string email = Model.EmailSelect[i];
                    <input type="hidden" name="EmailSelect[@i]" value="@email" />
                }
            </div>
        </div>
    </div>

    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">Роли</h3>
        </div>
        <div class="panel-body">
            <table class="table table-condensed table-hover">
                <thead>
                    <tr>
                        <th style="text-align:center">Название</th>
                        <th style="text-align:center"></th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Roles.Count > 0)
                    {
                        for (int i = 0; i < Model.Roles.Count; i++)
                        {
                            string role = Model.Roles[i];
                            <tr>
                                <td align="center">
                                    <input type="hidden" name="Roles[@i]" value="@role" />
                                    @role
                                </td>
                                <td align="center"><span class="glyphicon glyphicon-remove"></span></td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="1">Роли учетным записям не назначены</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">Группы</h3>
        </div>
        <div class="panel-body">
            <table class="table table-condensed table-hover">
                <thead>
                    <tr>
                        <th style="text-align:center">Название</th>
                        <th style="text-align:center"></th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Groups.Count > 0)
                    {
                        for (int i = 0; i < Model.Groups.Count; i++)
                        {
                            GroupViewModel group = Model.Groups[i];
                            <tr>
                                <td align="center">
                                    <input type="hidden" name="Groups[@i].Id" value="@group.Id" />
                                    <input type="hidden" name="Groups[@i].Name" value="@group.Name" />
                                    @group.Name
                                </td>
                                <td align="center"><span class="glyphicon glyphicon-remove"></span></td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="1">Учетные записи не состоят в ролях</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">Личная информация</h3>
        </div>
        <div class="panel-body">
            @if (Model.ClaimSelect.Count() > 0)
            {
                int claimCounter = 0;
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Название атрибута</th>
                            <th>Значение</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (string claimId in Model.ClaimSelect.Select(c => c.ClaimId).Distinct())
                        {
                            string attributeName = Model.ClaimSelect.FirstOrDefault(c => c.ClaimId == claimId).ProfileAttributeName;
                            <tr>
                                <td width="30%" align="center">
                                    <input type="hidden" name="Claims[@claimCounter].ClaimId" value="@claimId" />
                                    @attributeName
                                </td>
                                <td>
                                    <select class="form-control" name="Claims[@claimCounter].ClaimValue">
                                        <option></option>
                                        @{
                                            IEnumerable<UserClaimViewModel> claims = Model.ClaimSelect.Where(c => c.ClaimId == claimId && !string.IsNullOrEmpty(c.ClaimValue));
                                            foreach (UserClaimViewModel claim in claims)
                                            {
                                                bool selected = ((Model.Claims == null || Model.Claims.Count == 0) && claims.Count() == 1)
                                                    || (Model.Claims != null && Model.Claims.FirstOrDefault(c => c.ClaimId.Equals(claim.ClaimId) 
                                                    && !string.IsNullOrEmpty(c.ClaimValue) && c.ClaimValue.Equals(claim.ClaimValue)) != null);
                                                if (selected)
                                                {
                                                    <option selected="selected" value="@claim.ClaimValue">
                                                        @claim.ClaimValue
                                                    </option>
                                                }
                                                else
                                                {
                                                    <option value="@claim.ClaimValue">
                                                        @claim.ClaimValue
                                                    </option>
                                                }
                                            }
                                        }
                                    </select>
                                </td>
                            </tr>
                                                claimCounter++;
                                            }
                    </tbody>
                </table>
                                            }
                                            else
                                            {
                                                <div class="info">Список атрибутов профилей пуст</div>
                                            }
        </div>
    </div>

    <div>
        <button class="btn btn-success">Сохранить</button>
        <a role="button" href="/User/List" class="btn btn-default">Отмена</a>
    </div>
</form>

@section Scripts{
    <script src="~/project/user_scripts.js"></script>
}